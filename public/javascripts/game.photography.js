// Generated by CoffeeScript 1.12.7
(function() {
  var extend = function(child, parent) { for (var key in parent) { if (hasProp.call(parent, key)) child[key] = parent[key]; } function ctor() { this.constructor = child; } ctor.prototype = parent.prototype; child.prototype = new ctor(); child.__super__ = parent.prototype; return child; },
    hasProp = {}.hasOwnProperty;

  jQuery(document).ready(function() {
    var deg2rad, distanceTravelled, generateMarkers, googleMap, location, mark, photographyGame, player, processData, retrieveResources;
    deg2rad = function(deg) {
      return deg * (Math.PI / 180);
    };
    distanceTravelled = function(from, to) {
      var R, a, c, dLat, dLng, dist, lat1, lat2, lng1, lng2;
      lat1 = from.lat;
      lng1 = from.lng;
      lat2 = to.lat;
      lng2 = to.lng;
      R = 6371;
      dLat = deg2rad(lat2 - lat1);
      dLng = deg2rad(lng2 - lng1);
      a = Math.sin(dLat / 2) * Math.sin(dLat / 2) + Math.cos(deg2rad(lat1)) * Math.cos(deg2rad(lat2)) * Math.sin(dLng / 2) * Math.sin(dLng / 2);
      c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
      dist = R * c;
      return dist;
    };
    photographyGame = (function() {
      function photographyGame(debug, map1) {
        this.debug = debug;
        this.map = map1;
      }

      photographyGame.prototype.init = function() {};

      return photographyGame;

    })();
    location = (function() {
      function location(position, name, icon) {
        this.position = position;
        this.name = name;
        this.icon = icon;
        this.marker;
      }

      location.prototype.addTo = function(map) {
        var marker;
        if (this.icon) {
          marker = new google.maps.Marker({
            position: this.position,
            map: map,
            icon: this.icon,
            title: this.name
          });
        } else {
          marker = new google.maps.Marker({
            position: this.position,
            map: map,
            title: this.name
          });
        }
        this.marker = marker;
        return this.setListener(this.marker);
      };

      location.prototype.setListener = function(marker) {
        var self;
        self = this;
        return marker.addListener('click', function() {
          return mark.moveTo(self);
        });
      };

      return location;

    })();
    player = (function(superClass) {
      extend(player, superClass);

      function player(position, name, icon) {
        this.position = position;
        this.name = name;
        this.icon = icon;
        player.__super__.constructor.call(this, this.position, this.name, this.icon);
        this.playerMarker;
      }

      player.prototype.initTo = function(map) {
        return this.playerMarker = new google.maps.Marker({
          position: this.position,
          map: map,
          icon: this.icon,
          title: 'Mark'
        });
      };

      player.prototype.moveTo = function(location) {
        console.log("current position", this.position, "new position", location.position, "distance travelled", distanceTravelled(this.position, location.position) + 'km');
        this.position = location.position;
        return this.playerMarker.setPosition(new google.maps.LatLng(location.position.lat, location.position.lng));
      };

      return player;

    })(location);
    retrieveResources = function(amount) {
      var reqParam;
      reqParam = {
        resource_id: '9913b881-d76d-43f5-acd6-3541a130853d',
        limit: amount
      };
      return $.ajax({
        url: 'http://data.gov.au/api/action/datastore_search',
        data: reqParam,
        dataType: 'jsonp',
        cache: true
      });
    };
    processData = function(data) {
      var item, j, len, processedData, ref;
      processedData = [];
      ref = data.result.records;
      for (j = 0, len = ref.length; j < len; j++) {
        item = ref[j];
        if (item['dcterms:spatial']) {
          if (item['dcterms:spatial'].split(';')[1]) {
            processedData.push(item['dcterms:spatial'].split(';'));
          }
        }
      }
      return processedData;
    };
    generateMarkers = function(set) {
      var i, j, lat, len, lng, marker, place;
      marker = [];
      i = 0;
      for (j = 0, len = set.length; j < len; j++) {
        place = set[j];
        lat = parseFloat(place[1].split(',')[0]);
        lng = parseFloat(place[1].split(',')[1]);
        marker[i] = new location({
          lat: lat,
          lng: lng
        }, place[0]);
        marker[i].addTo(googleMap);
        i++;
      }
    };
    googleMap = new google.maps.Map($('#map')[0], {
      zoom: 6,
      center: {
        lat: -27.4698,
        lng: 153.0251
      }
    });
    mark = new player({
      lat: -25.363,
      lng: 151.044
    }, 'Mark', 'https://developers.google.com/maps/documentation/javascript/images/custom-marker.png');
    mark.initTo(googleMap);
    retrieveResources(100).then(function(res) {
      generateMarkers(processData(res));
    });
  });

}).call(this);
