// Generated by CoffeeScript 1.12.7
(function() {
  jQuery(document).ready(function() {
    var currentGame, processData, puzzleGame, retrieveResources;
    puzzleGame = (function() {
      function puzzleGame(debug, xsplit, ysplit, time) {
        this.debug = debug;
        this.xsplit = xsplit;
        this.ysplit = ysplit;
        this.time = time;
      }

      puzzleGame.prototype.init = function(resources) {
        this.resources = resources;
        this.solution = this.resources[Math.floor(Math.random() * this.resources.length)];
        this.reset();
        this.generateChoiceField(this.resources);
        this.generateTiles();
        return this.initTimer();
      };

      puzzleGame.prototype.initTimer = function(method) {
        var gameLoseLocal, interval, timeLeft, updateTimer;
        timeLeft = this.time;
        gameLoseLocal = this.gameLose;
        $('#timer').text('Time remaining: ' + timeLeft);
        updateTimer = function() {
          timeLeft--;
          $('#timer').text('Time remaining: ' + timeLeft);
          if (timeLeft === 0) {
            gameLoseLocal();
            clearInterval(interval);
          }
        };
        interval = window.setInterval(updateTimer, 1000);
        if (method === 'stop') {
          clearInterval(interval);
        }
      };

      puzzleGame.prototype.generateTiles = function() {
        var col, i, imgHeight, imgWidth, row, tile, tileHeight, tileTemplate, tileWidth, tiles;
        tileTemplate = $('#tileTemplate');
        tiles = this.xsplit * this.ysplit;
        imgWidth = $('#tileTemplate').width();
        imgHeight = $('#tileTemplate').height();
        tileWidth = imgWidth / this.xsplit;
        tileHeight = imgHeight / this.ysplit;
        i = 0;
        col = 0;
        while (col < this.ysplit) {
          row = 0;
          while (row < this.xsplit) {
            tile = $(tileTemplate.clone());
            tile.draggable();
            tile.show();
            tile.addClass('tile');
            tile.removeAttr('id', '');
            tile.css({
              'background-image': 'url(' + this.solution['High resolution image'] + ')',
              'background-position': -row * tileWidth + 'px ' + -col * tileHeight + 'px',
              'width': tileWidth,
              'height': tileHeight,
              'left': Math.floor(Math.random() * 400) + 'px',
              'top': Math.floor(Math.random() * 200) + 'px'
            });
            $('#gameArea').append(tile);
            i++;
            row++;
            if (this.debug) {
              console.log('created', i, 'tile at', row - 1, col);
            }
          }
          col++;
        }
        tileTemplate.hide();
        if (this.debug) {
          console.log('--- Width', imgWidth, 'Height', imgHeight, 'TileWidth', tileWidth, 'TileHight', tileHeight);
          return console.log('solution', this.getAnswer());
        }
      };

      puzzleGame.prototype.generateChoiceField = function(choices) {
        var choice, i, j, len, results;
        i = 1;
        results = [];
        for (j = 0, len = choices.length; j < len; j++) {
          choice = choices[j];
          if (choice === this.solution) {
            $('#selectionArea').append('<div class="choice" id="choice' + i + '"><img class="img-responsive" src="' + choice['High resolution image'] + '"</div>');
            this.setAnswerValue(i);
          } else {
            $('#selectionArea').append('<div class="choice" id="choice' + i + '"><img class="img-responsive" src="' + choice['High resolution image'] + '"</div>');
          }
          results.push(i++);
        }
        return results;
      };

      puzzleGame.prototype.setAnswerValue = function(value) {
        return this.solutionValue = value;
      };

      puzzleGame.prototype.getAnswer = function() {
        return [this.solution, this.solutionValue];
      };

      puzzleGame.prototype.reset = function() {
        return $('#selectionArea, #gameArea').empty();
      };

      puzzleGame.prototype.gameWin = function() {
        return alert('you won');
      };

      puzzleGame.prototype.gameLose = function() {
        return alert('you lost');
      };

      return puzzleGame;

    })();
    currentGame = new puzzleGame(true, 8, 8, 4);
    retrieveResources = function(amount) {
      var reqParam;
      reqParam = {
        resource_id: 'cf6e12d8-bd8d-4232-9843-7fa3195cee1c',
        limit: amount
      };
      return $.ajax({
        url: 'http://data.gov.au/api/action/datastore_search',
        data: reqParam,
        dataType: 'jsonp',
        cache: true
      });
    };
    processData = function(data) {
      var item, j, len, processedData, ref;
      processedData = [];
      ref = data.result.records;
      for (j = 0, len = ref.length; j < len; j++) {
        item = ref[j];
        if (item['High resolution image']) {
          processedData.push(item);
        }
      }
      return processedData;
    };
    $('#play').click(function() {
      retrieveResources(50).then(function(res) {
        currentGame.init(processData(res));
      });
    });
    $('#selectionArea').on('click', '.choice', function() {
      if (parseInt($(this).attr('id').match(/[0-9]+/)) === currentGame.getAnswer()[1]) {
        currentGame.gameWin();
      } else {
        currentGame.gameLose();
      }
    });
    $('#reset').click(function() {
      currentGame.reset();
    });
  });

}).call(this);
