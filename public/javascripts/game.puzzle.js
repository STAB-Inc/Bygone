// Generated by CoffeeScript 1.12.7
(function() {
  jQuery(document).ready(function() {
    var currentGame, processData, puzzleGame, retrieveResources;
    puzzleGame = (function() {
      function puzzleGame(debug, xsplit, ysplit) {
        this.debug = debug;
        this.xsplit = xsplit;
        this.ysplit = ysplit;
        this.timePassed;
      }

      puzzleGame.prototype.init = function(resources) {
        this.resources = resources;
        this.solution = this.resources[Math.floor(Math.random() * this.resources.length)];
        console.log(this.solution);
        this.reset();
        this.generateChoiceField(this.resources);
        this.generateTiles();
        return this.initTimer();
      };

      puzzleGame.prototype.initTimer = function() {
        var counter, time;
        time = 0;
        counter = function() {
          time += 1;
          $('#timer').text('Time: ' + time);
          return $('#timer').attr('value', time);
        };
        return this.timer = setInterval(counter, 1000);
      };

      puzzleGame.prototype.generateTiles = function() {
        var col, i, imgHeight, imgWidth, row, tile, tileHeight, tileTemplate, tileWidth, tiles;
        tileTemplate = $('#tileTemplate');
        tiles = this.xsplit * this.ysplit;
        imgWidth = $('#tileTemplate').width();
        imgHeight = $('#tileTemplate').height();
        tileWidth = imgWidth / this.xsplit;
        tileHeight = imgHeight / this.ysplit;
        i = 0;
        col = 0;
        while (col < this.ysplit) {
          row = 0;
          while (row < this.xsplit) {
            tile = $(tileTemplate.clone());
            tile.draggable({
              containment: $('#gameArea')
            });
            tile.show();
            tile.addClass('tile');
            tile.removeAttr('id', '');
            tile.css({
              'background-image': 'url(' + this.solution['High resolution image'] + ')',
              'background-position': -row * tileWidth + 'px ' + -col * tileHeight + 'px',
              'width': tileWidth,
              'height': tileHeight,
              'left': Math.floor(Math.random() * 50) + 'px',
              'top': Math.floor(Math.random() * 50) + 'px'
            });
            $('#gameArea').append(tile);
            i++;
            row++;
            if (this.debug) {
              console.log('created', i, 'tile at', row - 1, col);
            }
          }
          col++;
        }
        tileTemplate.hide();
        if (this.debug) {
          console.log('--- Width', imgWidth, 'Height', imgHeight, 'TileWidth', tileWidth, 'TileHight', tileHeight);
          return console.log('solution', this.getAnswer());
        }
      };

      puzzleGame.prototype.generateChoiceField = function(choices) {
        var choice, i, j, len, results;
        i = 1;
        results = [];
        for (j = 0, len = choices.length; j < len; j++) {
          choice = choices[j];
          if (choice === this.solution) {
            $('#selectionArea').append('<div class="choice" id="choice' + i + '"><img class="img-responsive" src="' + choice['Thumbnail image'] + '"</div>');
            this.setAnswerValue(i);
          } else {
            $('#selectionArea').append('<div class="choice" id="choice' + i + '"><img class="img-responsive" src="' + choice['Thumbnail image'] + '"</div>');
          }
          results.push(i++);
        }
        return results;
      };

      puzzleGame.prototype.setAnswerValue = function(value) {
        return this.solutionValue = value;
      };

      puzzleGame.prototype.getAnswer = function() {
        return [this.solution, this.solutionValue];
      };

      puzzleGame.prototype.reset = function() {
        $('#selectionArea, #gameArea').empty();
        clearInterval(this.timer);
        return this.time = 0;
      };

      puzzleGame.prototype.gameWin = function() {
        $('.winScreen .timeTaken').text('Time taken ' + $('#timer').attr('value') + ' seconds');
        $('.winScreen').show();
        $('.winScreen img').attr('src', this.solution['High resolution image']);
        $('.winScreen .soldierName').text(this.solution['Full name (from National Archives of Australia)']);
        $('.winScreen .soldierDesc').text(this.solution['Title of image']);
        $('.play').show();
        return this.reset();
      };

      puzzleGame.prototype.gameLose = function() {
        alert('Wrong Answer');
        return $('.play').show();
      };

      return puzzleGame;

    })();
    retrieveResources = function(amount) {
      var reqParam;
      reqParam = {
        resource_id: 'cf6e12d8-bd8d-4232-9843-7fa3195cee1c',
        limit: amount
      };
      return $.ajax({
        url: 'https://data.gov.au/api/action/datastore_search',
        data: reqParam,
        dataType: 'jsonp',
        cache: true
      });
    };
    processData = function(data) {
      var item, j, len, processedData, ref;
      processedData = [];
      ref = data.result.records;
      for (j = 0, len = ref.length; j < len; j++) {
        item = ref[j];
        if (item['High resolution image']) {
          processedData.push(item);
        }
      }
      return processedData;
    };
    currentGame = null;
    $('.play').click(function() {
      currentGame = new puzzleGame(false, 8, 8);
      retrieveResources(50).then(function(res) {
        currentGame.init(processData(res));
      });
      $(this).hide();
      $('.winScreen').hide();
    });
    $('#selectionArea').on('click', '.choice', function() {
      if (parseInt($(this).attr('id').match(/[0-9]+/)) === currentGame.getAnswer()[1]) {
        currentGame.gameWin();
      } else {
        currentGame.gameLose();
      }
    });
    $('#reset').click(function() {
      currentGame.reset();
    });
  });

}).call(this);
